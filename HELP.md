# Spring Boot september 2024, 2024-11-05

## Voorraad Applicatie
* [https://github.com/corbroekhuis/voorraad-app-jdbc.git](https://github.com/corbroekhuis/voorraad-app-jdbc.git)


<br/><br/>
<br/><br/>


### Gebruikte JDBCTemplate methodes staan hier beschreven
* [https://www.tutorialspoint.com/springjdbc/index.htm](https://www.tutorialspoint.com/springjdbc/index.htm)
  <br/><br/>
  - Read Query: [https://www.tutorialspoint.com/springjdbc/springjdbc_read_query.htm](https://www.tutorialspoint.com/springjdbc/springjdbc_read_query.htm)
  - Update Query: [https://www.tutorialspoint.com/springjdbc/springjdbc_update_query.htm](https://www.tutorialspoint.com/springjdbc/springjdbc_update_query.htm)
  - Delete Query: [https://www.tutorialspoint.com/springjdbc/springjdbc_delete_query.htm](https://www.tutorialspoint.com/springjdbc/springjdbc_delete_query.htm)
  - SimpleJdbcInsert: [https://www.tutorialspoint.com/springjdbc/springjdbc_simplejdbcinsert.htm](https://www.tutorialspoint.com/springjdbc/springjdbc_simplejdbcinsert.htm)

<br/><br/>
<br/><br/>
<br/><br/>
<br/><br/>
<br/><br/>
<br/><br/>

#### <a id="top"></a>
### Index:
* [Create tabel Artikelen](#artikelen)
* [Create tabel Reviews](#reviews)
* [Swagger annotations](#swagger)
* [Properties](#properties)
* [Basic Authentication](#basic-authentication)
* [Encoding](#encode)
* [Header Filter](#filter)

<br/><br/>
<br/><br/>
<br/><br/>
<br/><br/>

## <a id="artikelen"></a>Create Tabel Artikelen

```SQL
DROP TABLE IF EXISTS artikelen;
CREATE TABLE artikelen(
   ID BIGINT GENERATED BY DEFAULT AS IDENTITY (START WITH 1000000) PRIMARY KEY,
   NAAM VARCHAR(20) NOT NULL,
   OMSCHRIJVING  VARCHAR(200) NOT NULL,
   EAN VARCHAR(20) NOT NULL,
   ARTIKEL_NUMMER VARCHAR(20) NOT NULL,
   VOORRAAD INT NOT NULL ,
   MINIMUM_VOORRAAD INT NOT NULL
);

INSERT INTO artikelen ( naam, omschrijving, ean, artikel_nummer, voorraad, minimum_voorraad) VALUES
('Fat Bike B2000', 'Stoere, opvoerbare zwarte Fat Bike', '8711999400110', '40011', 20, 10),
('Kruimeldief P41', 'Krachtige oplaadbare kruimelzuiger met diverse hulpstukken', '8711999500210', '50021', 20, 10),
('HD Dash Cam', 'Hoge resolutie Dash Cam voor professioneel gebruik', '8711999600190', '60019', 20, 10),
('Tafellamp Sunny', 'Dimbare tafellamp voor sfeervol dineren', '8711999900220', '90022', 20, 10),
('Batterijen AA', 'High-Power batterijen met lange levensduur', '8711999200270', '20027', 20, 10);


```

## <a id="reviews"></a>Create Tabel Reviews

```SQL
DROP TABLE IF EXISTS reviews;
CREATE TABLE reviews(
   ID BIGINT GENERATED BY DEFAULT AS IDENTITY (START WITH 2000000) PRIMARY KEY,
   ARTIKEL_ID BIGINT NOT NULL,
   TEKST VARCHAR(200) NOT NULL,
   STERREN INT NOT NULL
);

INSERT INTO reviews (artikel_id, tekst, sterren) VALUES
(1000000, 'Prima Fat Bike, makkelijk op te voeren en niet duur', 4),
(1000000, 'Goeie prijs maar remmen zijn niet goed ', 3),
(1000001, 'Wauw, zuigt beter dan de stofzuiger. Ligt goed in de hand', 4),
(1000001, 'Batterij snel leeg maar verder prima', 4),
(1000001, 'Hulpstukken zijn waardeloos', 1),
(1000002, 'Beelden zijn scherp en mooie kleuren', 4),
(1000002, 'Goeie prijs/kwaliteit verhouding', 4),
(1000002, 'Zuignap niet al te best, valt er steeds af', 2),
(1000003, 'Voor weining geld romantisch dineren', 4),
(1000003, 'Dimmer niet erg stabiel', 2),
(1000004, 'Zeer geschikt voor camera', 4),
(1000004, 'Duur maar ze leveren veel power', 3);

```

<br/><br/>
<br/><br/>
* [Top](#top)
## <a id="swagger"></a>Swagger annotations

Plaats de code boven

```java
    public ResponseEntity<ArticleDTO> createArticle(@RequestBody ArticleDTO articleDTO){
```

```java
    @Operation(summary = "Create/Update voor een artikel",
            description= """
                <ul>
                    <li> Voeg een nieuw artikel toe of update een bestaand artikel</li>
                    <li> Als er geen id is gespecificeerd in de json dan wordt een nieuw artikel aangemaakt</li>
                    <li> Als er wel een id is gespecificeerd dan wordt het bestaande artikel geupdate </li>
                    <li> Voeg in beide gevallen geen ean toe; dat wordt gegenereerd</li>
                    <li> Nota Bene: kies een niet bestaand artikelnummer</li>
                </ul>
                """)
    @ApiResponses(value = {
            @ApiResponse(responseCode = "200", description = "Bericht toegevoegd",
                    content = {@Content(mediaType = "application/json",
                            schema = @Schema(implementation = Article.class),
                            examples = {
                                    @ExampleObject(
                                            name = "create",
                                            summary = "Voeg een artikel toe",
                                            description = """
                                                    Deze voorbeeld JSON, een nieuw artikel toe<br>
                                                    met artikelnummer '50011'<br>
                                                    het EAN nummer wordt gegenereerd<br>
                                                    Het artikelnummer mag nog niet bestaan in de tabel<br>
                                                    """,
                                            value = """
                                                      {
                                                        "name": "Fat Bike B",
                                                        "description": "Black Fat Bike",
                                                        "articleNumber": "50011",
                                                        "stock": 20,
                                                        "minimumStock": 10
                                                      }
                                                    """
                                    ),
                                    @ExampleObject(
                                            name = "update",
                                            summary = "Update een bestaand artikel",
                                            description = """
                                                    Deze voorbeeld JSON, update het artikel met id = 7<br>
                                                    """,
                                            value = """
                                                      {
                                                        "id": 7,
                                                        "name": "Fat Bike B",
                                                        "description": "Black Fat Bike updated",
                                                        "articleNumber": "50011",
                                                        "stock": 50,
                                                        "minimumStock": 10
                                                      }
                                                    """
                                    )
                            }),
                    }),
            @ApiResponse(responseCode = "400", description = "Bad Request, artikel met zelfde artikelnummer bestaat al",
                    content = {@Content(mediaType = "application/json",
                            schema = @Schema(implementation = String.class),
                            examples = {
                                    @ExampleObject(
                                            name = "example-400",
                                            summary = "Artikelnummer bestaat al",
                                            description = """
                                                    Deze voorbeeld JSON, voegt een artikel toe<br>
                                                    echter, artikelnummer 50011 bestaat al<br>
                                                    er wordt geen waarde teruggegeven<br>
                                                    """,
                                            value = """
                                                      {
                                                        "name": "Fat Bike B",
                                                        "description": "Black Fat Bike",
                                                        "articleNumber": "50011",
                                                        "stock": 20,
                                                        "minimumStock": 10
                                                      }
                                                    """
                                    )
                            }),
                    })
    })
```

<br/><br/>
<br/><br/>

* [Top](#top)
## <a id="properties"></a>Properties


```properties
# Default: 8080
server.port=8081

ean.aansluitnummer=11999
fixed-delay.in.milliseconds=40000
spring.application.name=voorraad-app

spring.h2.console.enabled=true
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.url=jdbc:h2:file:C:/Temp/voorraad
spring.datasource.username=sa
spring.datasource.password=sa
# jpa, niet meer nodig
# spring.jpa.hibernate.ddl-auto=create

```

<br/><br/>
<br/><br/>
* [Top](#top)

Eventueel toevoegen aan class ```Article```
```Java
    public Map<String, Object> getParameterMap(){

        Map<String,Object> parameters = new HashMap<String,Object>();
        parameters.put("naam", name);
        parameters.put("omschrijving", description);
        parameters.put("ean", ean);
        parameters.put("artikel_nummer", articleNumber);
        parameters.put("voorraad", stock);
        parameters.put("minimum_voorraad", minimumStock);
        
        return parameters;
    }
```

```Java
    public Object[] getValueArray(){

        Object[] valueArray = {
                name,
                description,
                articleNumber,
                ean,
                stock,
                minimumStock,
                id
		};
        
        return valueArray;
    }
```

<br><br>
<br><br>
* [Top](#top)

## <a id="basic-authentication"></a>Basic Authentication

```java
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.provisioning.InMemoryUserDetailsManager;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.web.servlet.config.annotation.EnableWebMvc;

import static org.springframework.security.config.Customizer.withDefaults;

//@Configuration
//@EnableWebMvc
public class BasicAuthConfig {

//    @Bean
    public UserDetailsService userDetailsService() {
        UserDetails user1 =
                User.builder()
                        .username("user")
                        .password(passwordEncoder().encode("user"))
                        .roles("USER")
                        .build();
        UserDetails user2 =
                User.builder()
                        .username("admin")
                        .password(passwordEncoder().encode("admin"))
                        .roles("USER", "ADMIN")
                        .build();
        return new InMemoryUserDetailsManager(user1, user2);
    }

//@Bean
BCryptPasswordEncoder passwordEncoder() {
    return new BCryptPasswordEncoder();
}

//@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {

    http.headers(header -> header.frameOptions(options -> options.sameOrigin()));
    http.csrf(csrf -> csrf.disable())
        .authorizeHttpRequests(auth -> auth
            .requestMatchers("/"
                    , "/h2-console/**"
                    , "/v2/api-docs"
                    , "/configuration/ui"
                    , "/swagger-resources/**"
                    , "/configuration/security"
                    , "/swagger-ui/**"
                    , "/webjars/**"
            ).permitAll()
            .requestMatchers("/api").authenticated()
            .anyRequest().authenticated()
            )
        .httpBasic(withDefaults());

        return http.build();
    }
}
```

<br><br>
<br><br>
* [Top](#top)

## <a id="encode"></a>Create token from user and password 

```java
    public static String getBasicAuth( String user, String password){

        StringBuilder sb = new StringBuilder("Basic ");

        String token = Base64.getUrlEncoder().encodeToString(  ( user + ":" + password).getBytes());
        sb.append( token);
        System.out.println( sb);

        return sb.toString();
    }
```

<br><br>
<br><br>
* [Top](#top)

## <a id="filter"></a>Header Filter

```java
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.util.Enumeration;

@Component
public class HeaderFilter extends OncePerRequestFilter {

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        
        Enumeration<String> headerNames = request.getHeaderNames();

        while(headerNames.hasMoreElements()){
            String headerName = headerNames.nextElement();
            String value = request.getHeader(headerName);
            System.out.println( headerName + ": " + value);
        }
        filterChain.doFilter(request, response);
    }
}

```

<br><br>
<br><br>
* [Top](#top)